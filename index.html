<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ—¥å¸¸ä»»åŠ¡æ¸…å•</title>
    <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
    <style>
        /* --- 1. è§†è§‰è®¾è®¡ç³»ç»Ÿ --- */
        :root {
            --bg-sky: #E0F7FA;
            --bg-grass: #C8E6C9;
            --totoro-grey: #9EA7AA;
            --totoro-belly: #FFFDF5;
            --forest-green: #4E7C57;
            --wood-brown: #795548;
            --acorn-gold: #FBC02D;
            --soot-black: #37474F;
            --danger-red: #E57373;
        }

        body {
            font-family: 'Varela Round', sans-serif;
            background: linear-gradient(180deg, var(--bg-sky) 0%, var(--bg-grass) 100%);
            min-height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ï¼Œé˜²æ­¢é•¿é¡µé¢æ— æ³•æ»šåŠ¨ */
            padding: 40px 20px;
            color: var(--soot-black);
            box-sizing: border-box; /* ç¡®ä¿paddingè®¡ç®—åœ¨å®½åº¦å†… */
        }

        .app-container {
            background-color: var(--totoro-belly);
            width: 100%;
            max-width: 550px;
            border-radius: 40px;
            box-shadow: 0 20px 50px rgba(78, 124, 87, 0.2), inset 0 0 0 8px rgba(158, 167, 170, 0.2);
            padding: 30px;
            box-sizing: border-box;
            position: relative;
            transition: all 0.3s ease; /* å¢åŠ å¹³æ»‘è¿‡æ¸¡ */
        }

        /* --- å¤´éƒ¨æ ·å¼ä¿®æ”¹ --- */
        .header { text-align: center; margin-bottom: 30px; }
        
        /* Logo å›¾ç‰‡æ ·å¼ */
        .header-logo-img {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            background-color: white;
            transition: transform 0.3s, width 0.3s, height 0.3s; /* å¢åŠ å¤§å°è¿‡æ¸¡ */
        }
        .header-logo-img:hover {
            transform: scale(1.05) rotate(5deg);
        }

        .header h1 { color: var(--wood-brown); margin: 0; font-size: 1.6rem; transition: font-size 0.3s; }
        .streak-tag {
            display: inline-block; background: var(--forest-green); color: white;
            padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 8px;
        }

        /* è¾“å…¥åŒº */
        .main-input-group { display: flex; gap: 10px; margin-bottom: 30px; }
        .main-input {
            flex: 1; padding: 12px 20px; border: 3px solid #ECEFF1; border-radius: 30px;
            font-size: 1rem; outline: none; transition: 0.3s;
            min-width: 0; /* é˜²æ­¢Flexå­é¡¹æº¢å‡º */
        }
        .main-input:focus { border-color: var(--totoro-grey); }
        .btn-add-main {
            background: var(--totoro-grey); color: white; border: none; padding: 0 20px;
            border-radius: 30px; font-weight: bold; cursor: pointer; white-space: nowrap;
            transition: all 0.2s;
        }
        .btn-add-main:active { transform: scale(0.95); }

        /* ä»»åŠ¡å¡ç‰‡ */
        .task-card {
            background: white; border: 2px solid #ECEFF1; border-radius: 20px;
            margin-bottom: 20px; padding: 20px; transition: 0.3s; position: relative;
        }
        .task-card.completed-card {
            background: #F1F8E9; border-color: #C5E1A5; opacity: 1;
        }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px dashed #EEE;
        }
        .task-title {
            font-size: 1.1rem; font-weight: bold; color: var(--wood-brown);
            display: flex; align-items: center; gap: 10px;
            word-break: break-all; /* é˜²æ­¢é•¿æ ‡é¢˜æ’‘ç ´å¸ƒå±€ */
        }

        .btn-soot-delete {
            background: var(--soot-black); width: 28px; height: 28px; border-radius: 50%;
            border: none; cursor: pointer; position: relative; transition: 0.2s; flex-shrink: 0;
        }
        .btn-soot-delete::before, .btn-soot-delete::after {
            content: ''; position: absolute; top: 8px; width: 5px; height: 5px; background: white; border-radius: 50%;
        }
        .btn-soot-delete::before { left: 6px; }
        .btn-soot-delete::after { right: 6px; }
        .btn-soot-delete:hover { transform: scale(1.1) rotate(10deg); }

        /* å­ä»»åŠ¡ */
        .subtask-list { list-style: none; padding: 0; margin: 0; }
        .subtask-item {
            display: flex; align-items: center; margin-bottom: 8px;
            padding: 8px 12px; background: #FAFAFA; border-radius: 12px;
        }
        .subtask-text { 
            flex: 1; font-size: 0.95rem; color: #555; margin: 0 10px; 
            word-break: break-all; /* é˜²æ­¢é•¿æ–‡æœ¬æº¢å‡º */
        }
        .subtask-item.done .subtask-text { text-decoration: line-through; color: #999; }

        .btn-sub-delete {
            background: none; border: none; color: #CCC; font-size: 1.2rem;
            cursor: pointer; line-height: 1; padding: 0 5px; min-width: 30px; /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
        }
        .btn-sub-delete:hover { color: var(--danger-red); transform: scale(1.2); }

        /* å¤é€‰æ¡† */
        .acorn-checkbox {
            width: 20px; height: 20px; border: 2px solid var(--wood-brown);
            border-radius: 50% 50% 5px 50%; cursor: pointer; transform: rotate(45deg);
            transition: 0.2s; flex-shrink: 0;
        }
        .subtask-item.done .acorn-checkbox {
            background: var(--acorn-gold); border-color: var(--acorn-gold);
        }
        
        .main-checkbox {
            width: 24px; height: 24px; border: 3px solid var(--wood-brown);
            border-radius: 50% 50% 5px 50%; cursor: pointer; transform: rotate(45deg);
            transition: 0.2s; flex-shrink: 0;
        }
        .completed-card .main-checkbox {
            background: var(--forest-green); border-color: var(--forest-green);
        }

        .add-subtask-row { display: flex; gap: 8px; margin-top: 15px; }
        .sub-input {
            flex: 1; border: none; background: #F0F0F0; padding: 8px 15px;
            border-radius: 20px; font-size: 0.9rem; outline: none;
            min-width: 0;
        }
        .btn-add-sub {
            background: white; border: 2px solid var(--forest-green); color: var(--forest-green);
            border-radius: 20px; padding: 0 12px; cursor: pointer; font-size: 1.2rem; line-height: 1;
            flex-shrink: 0; /* é˜²æ­¢æŒ‰é’®è¢«å‹ç¼© */
        }

        /* æ—¥å† */
        .calendar-box { margin-top: 40px; background: white; border-radius: 20px; padding: 20px; border: 4px solid var(--wood-brown); }
        .calendar-header { text-align: center; color: var(--wood-brown); font-weight: bold; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-leaf {
            aspect-ratio: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #EEE; border-radius: 4px 15px 4px 15px; font-size: 0.75rem; color: #AAA; position: relative;
        }
        .day-leaf.today { border: 2px solid var(--forest-green); background: white; color: var(--forest-green); font-weight: bold; }
        
        /* å°èŠ±æ ·å¼ */
        .flower-icon { font-size: 1rem; margin-top: 2px; }
        .flower-count {
            font-size: 0.65rem; color: white; background: var(--acorn-gold); border-radius: 10px;
            padding: 1px 6px; position: absolute; bottom: -5px; right: -5px; box-shadow: 1px 1px 2px rgba(0,0,0,0.2);
            font-weight: bold;
        }

        .footer-controls { margin-top: 20px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .text-link { color: #AAA; font-size: 0.8rem; cursor: pointer; text-decoration: underline; padding: 5px; }

        /* --- 2. è‡ªé€‚åº”/å“åº”å¼å¸ƒå±€ (å…³é”®ä¿®æ”¹) --- */
        
        /* å¹³æ¿å’Œçª„å±ç”µè„‘ (æœ€å¤§å®½åº¦ 768px) */
        @media screen and (max-width: 768px) {
            body {
                padding: 20px 10px; /* å‡å°‘é¡µé¢å¤–è¾¹è· */
            }
            .app-container {
                padding: 25px 20px; /* ç¨å¾®å‡å°‘å†…éƒ¨padding */
                max-width: 100%; /* å æ»¡å¯ç”¨ç©ºé—´ */
            }
        }

        /* æ‰‹æœºç«¯ (æœ€å¤§å®½åº¦ 480px) */
        @media screen and (max-width: 480px) {
            body {
                padding: 10px 5px; /* æ‰‹æœºç«¯æçª„å¤–è¾¹è· */
            }
            
            .app-container {
                border-radius: 25px; /* åœ†è§’å˜å°ä¸€ç‚¹ */
                padding: 20px 15px; /* å†…å®¹åŒºåŸŸæ›´ç´§å‡‘ */
                box-shadow: 0 10px 25px rgba(78, 124, 87, 0.2), inset 0 0 0 5px rgba(158, 167, 170, 0.2);
            }

            /* Logo ç¼©å° */
            .header-logo-img {
                width: 90px;
                height: 90px;
                margin-bottom: 10px;
            }
            .header h1 {
                font-size: 1.4rem;
            }

            /* è¾“å…¥æ¡†å’Œä¸»æŒ‰é’®è°ƒæ•´ */
            .main-input-group {
                gap: 8px;
                margin-bottom: 20px;
            }
            .main-input {
                padding: 10px 15px;
                font-size: 0.95rem;
            }
            .btn-add-main {
                padding: 0 15px; /* æŒ‰é’®å˜çª„ */
                font-size: 0.9rem;
            }

            /* ä»»åŠ¡å¡ç‰‡è°ƒæ•´ */
            .task-card {
                padding: 15px;
                border-radius: 15px;
            }
            .task-title {
                font-size: 1rem;
            }
            .subtask-item {
                padding: 6px 10px;
            }
            
            /* æ—¥å†è°ƒæ•´ */
            .calendar-box {
                margin-top: 25px;
                padding: 15px;
            }
            .calendar-grid {
                gap: 3px; /* ç¼©å°æ ¼å­é—´è· */
            }
            .day-leaf {
                font-size: 0.65rem; /* ç¼©å°å­—ä½“ */
                border-radius: 3px 10px 3px 10px;
            }
            .flower-icon {
                font-size: 0.8rem;
            }
            .flower-count {
                font-size: 0.55rem;
                padding: 0 4px;
                bottom: -3px; right: -3px;
            }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="header">
            <img src="./xiaohui_cartoon.jpg" alt="Logo" class="header-logo-img" onerror="this.style.display='none'">
            
            <h1>æ—¥å¸¸ä»»åŠ¡æ¸…å•</h1>
            <div class="streak-tag">è¿ç»­æ‰“å¡ <span id="streakDisplay">0</span> å¤©</div>
        </header>

        <div class="main-input-group">
            <input type="text" class="main-input" id="newMainTaskInput" placeholder="åˆ›å»ºä»Šæ—¥å¤§ä»»åŠ¡..." onkeypress="handleMainEnter(event)">
            <button class="btn-add-main" onclick="addMainTask()">åˆ›å»º</button>
        </div>

        <div id="taskContainer"></div>

        <div class="calendar-box">
            <div class="calendar-header" id="calendarTitle"></div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>

        <div class="footer-controls">
            <span class="text-link" onclick="exportData()">å¤‡ä»½æ•°æ®</span>
            <label class="text-link">æ¢å¤æ•°æ® <input type="file" style="display:none" onchange="importData(this)"></label>
        </div>
    </div>

    <script>
        const DB_KEY = 'daily_task_totoro_v5'; 
        let appData = { history: {}, lastLogin: "" };

        const getToday = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            return new Date(d.getTime() - offset).toISOString().split('T')[0];
        };
        const TODAY = getToday();

        // --- åˆå§‹åŒ– ---
        function init() {
            const saved = localStorage.getItem(DB_KEY);
            if (saved) {
                try { appData = JSON.parse(saved); } catch(e) { console.log("Init Error"); }
            }
            if (!appData.history[TODAY]) {
                appData.history[TODAY] = { tasks: [], flowerCount: 0 };
            }
            save(); 
            render();
        }

        function save() {
            calculateFlowers(); 
            updateStreak();
            localStorage.setItem(DB_KEY, JSON.stringify(appData));
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---

        function calculateFlowers() {
            const todayData = appData.history[TODAY];
            if (!todayData || !todayData.tasks) return;
            const completedTasks = todayData.tasks.filter(t => t.completed).length;
            todayData.flowerCount = completedTasks;
        }

        // 1. å¤§ä»»åŠ¡ç®¡ç†
        function addMainTask() {
            const input = document.getElementById('newMainTaskInput');
            const title = input.value.trim();
            if (!title) return;
            appData.history[TODAY].tasks.push({
                id: Date.now(), title: title, subtasks: [], completed: false
            });
            input.value = '';
            save(); render();
        }
        function handleMainEnter(e) { if(e.key === 'Enter') addMainTask(); }

        function deleteMainTask(id) {
            if(confirm('ç¡®å®šåˆ é™¤è¿™ä¸ªå¤§ä»»åŠ¡å—ï¼Ÿåˆ é™¤åå°èŠ±ä¹Ÿä¼šå¯¹åº”å‡å°‘å“¦ã€‚')) {
                appData.history[TODAY].tasks = appData.history[TODAY].tasks.filter(t => t.id !== id);
                save(); render();
            }
        }

        // 2. å­ä»»åŠ¡ç®¡ç†
        function addSubTask(parentId) {
            const input = document.getElementById(`sub-input-${parentId}`);
            const text = input.value.trim();
            if (!text) return;
            
            const task = appData.history[TODAY].tasks.find(t => t.id === parentId);
            if (task) {
                task.subtasks.push({ text: text, done: false });
                checkParentStatus(task); 
                save(); render();
            }
        }
        function handleSubEnter(e, parentId) { if(e.key === 'Enter') addSubTask(parentId); }

        function deleteSubTask(parentId, subIndex) {
            const task = appData.history[TODAY].tasks.find(t => t.id === parentId);
            if (task) {
                task.subtasks.splice(subIndex, 1);
                checkParentStatus(task);
                save(); render();
            }
        }

        function toggleSubTask(parentId, subIndex) {
            const task = appData.history[TODAY].tasks.find(t => t.id === parentId);
            if (task) {
                task.subtasks[subIndex].done = !task.subtasks[subIndex].done;
                checkParentStatus(task);
                save(); render();
            }
        }

        function toggleMainTaskDirect(parentId) {
            const task = appData.history[TODAY].tasks.find(t => t.id === parentId);
            if (task && task.subtasks.length === 0) {
                task.completed = !task.completed;
                save(); render();
            }
        }

        // çŠ¶æ€æ£€æŸ¥
        function checkParentStatus(task) {
            if (task.subtasks.length > 0) {
                task.completed = task.subtasks.every(st => st.done);
            } else {
                task.completed = false; 
            }
        }

        // è¿èƒœ
        function updateStreak() {
            let streak = 0;
            let d = new Date();
            while(true) {
                const dayStr = new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().split('T')[0];
                const record = appData.history[dayStr];
                
                if (record && record.flowerCount > 0) {
                    streak++;
                    d.setDate(d.getDate() - 1);
                } else {
                    if (dayStr === TODAY && (!record || record.flowerCount === 0)) {
                        d.setDate(d.getDate() - 1);
                        continue; 
                    }
                    break;
                }
            }
            document.getElementById('streakDisplay').innerText = streak;
        }

        // --- æ¸²æŸ“ ---
        function render() {
            const container = document.getElementById('taskContainer');
            container.innerHTML = '';
            const tasks = appData.history[TODAY].tasks;

            if (tasks.length === 0) {
                container.innerHTML = `<div style="text-align:center;color:#aaa;margin-top:20px;">è¿˜æ²¡æœ‰ä»»åŠ¡å‘¢</div>`;
            }

            tasks.forEach(task => {
                const hasSubs = task.subtasks.length > 0;
                const mainCheckAction = hasSubs ? '' : `onclick="toggleMainTaskDirect(${task.id})"`;
                const mainCursor = hasSubs ? 'default' : 'pointer';
                const mainOpacity = hasSubs ? '0.6' : '1';

                let subHtml = '';
                task.subtasks.forEach((sub, idx) => {
                    subHtml += `
                        <li class="subtask-item ${sub.done ? 'done' : ''}">
                            <div class="acorn-checkbox" onclick="toggleSubTask(${task.id}, ${idx})"></div>
                            <span class="subtask-text">${sub.text}</span>
                            <button class="btn-sub-delete" onclick="deleteSubTask(${task.id}, ${idx})" title="åˆ é™¤æ­¥éª¤">Ã—</button>
                        </li>
                    `;
                });

                const card = document.createElement('div');
                card.className = `task-card ${task.completed ? 'completed-card' : ''}`;
                card.innerHTML = `
                    <div class="card-header">
                        <div class="task-title">
                            <div class="main-checkbox" ${mainCheckAction} 
                                 style="cursor:${mainCursor}; opacity:${mainOpacity}; 
                                 ${task.completed ? 'background:var(--forest-green);border-color:var(--forest-green)' : ''}"></div>
                            ${task.title}
                        </div>
                        <button class="btn-soot-delete" onclick="deleteMainTask(${task.id})"></button>
                    </div>
                    <ul class="subtask-list">${subHtml}</ul>
                    <div class="add-subtask-row">
                        <input id="sub-input-${task.id}" class="sub-input" placeholder="æ·»åŠ æ­¥éª¤..." onkeypress="handleSubEnter(event, ${task.id})">
                        <button class="btn-add-sub" onclick="addSubTask(${task.id})">+</button>
                    </div>
                `;
                container.appendChild(card);
            });

            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth();
            document.getElementById('calendarTitle').innerText = `${year}å¹´ ${month + 1}æœˆ`;
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'day-leaf';
                cell.innerHTML = `<span>${d}</span>`;
                
                const dStr = `${year}-${(month+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                if(dStr === TODAY) cell.classList.add('today');

                const record = appData.history[dStr];
                
                if(record && record.flowerCount > 0) {
                    cell.style.backgroundColor = '#81C784';
                    cell.style.color = 'white';
                    
                    let icon = '<div class="flower-icon">ğŸŒº</div>';
                    if(record.flowerCount >= 2) {
                        icon += `<div class="flower-count">x${record.flowerCount}</div>`;
                    }
                    cell.innerHTML += icon;
                }
                grid.appendChild(cell);
            }
        }

        function exportData() {
            const a = document.createElement('a');
            a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            a.download = `totoro_tasks_${TODAY}.json`;
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    appData = JSON.parse(e.target.result);
                    save(); render(); alert("æ•°æ®å·²æ¢å¤ï¼");
                } catch(err) { alert("æ–‡ä»¶é”™è¯¯"); }
            };
            reader.readAsText(input.files[0]);
        }

        init();
    </script>
</body>
</html>
